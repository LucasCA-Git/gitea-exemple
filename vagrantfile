Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu/jammy64"

  # Portas do Gitea
  config.vm.network "forwarded_port", guest: 3000, host: 3000
  config.vm.network "forwarded_port", guest: 22, host: 2222

  # Compartilhar pasta do projeto
  config.vm.synced_folder ".", "/home/vagrant/gitea"

  config.vm.provider "virtualbox" do |vb|
    vb.memory = 4096
    vb.cpus = 2
  end

  config.vm.provision "shell", inline: <<-SHELL
    set -e

    apt-get update -y

    # Dependências básicas
    apt-get install -y \
      ca-certificates \
      curl \
      gnupg \
      lsb-release

    # Docker + Docker Compose (via APT)
    apt-get install -y docker.io docker-compose-plugin

    systemctl enable docker
    systemctl start docker

    # Docker sem sudo
    usermod -aG docker vagrant

    # Subir Gitea (primeira vez pode precisar de sudo)
    cd /home/vagrant/gitea
    docker compose up -d || sudo docker compose up -d
  SHELL
end
